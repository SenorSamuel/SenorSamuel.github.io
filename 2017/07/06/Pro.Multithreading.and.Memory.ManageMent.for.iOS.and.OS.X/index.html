<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Samuel blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Problems:    一个非alloc/new/copy/muteCopy返回对象的方法应该由谁管理内存?   AutoReleasePool也需要进行内存管理吗?如果要,谁来管理?    Chapter1 Life Before Automatic Reference Counting Reference Counted Memory Management Overview Memory">
<meta property="og:type" content="article">
<meta property="og:title" content="Pro.Multithreading.and.Memory.Management.for.iOS.and.OS.X(MRC和ARC)">
<meta property="og:url" content="http://yoursite.com/2017/07/06/Pro.Multithreading.and.Memory.ManageMent.for.iOS.and.OS.X/index.html">
<meta property="og:site_name" content="Samuel blog">
<meta property="og:description" content="Problems:    一个非alloc/new/copy/muteCopy返回对象的方法应该由谁管理内存?   AutoReleasePool也需要进行内存管理吗?如果要,谁来管理?    Chapter1 Life Before Automatic Reference Counting Reference Counted Memory Management Overview Memory">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170706152431.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170706154549.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170706173000.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707105639.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707113104.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707113946.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707141849.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707142124.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717103437.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170711111007.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170711144133.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170711144249.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170713155559.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717173215.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717194057.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717194341.png">
<meta property="og:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717194612.png">
<meta property="og:updated_time" content="2017-07-20T08:16:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pro.Multithreading.and.Memory.Management.for.iOS.and.OS.X(MRC和ARC)">
<meta name="twitter:description" content="Problems:    一个非alloc/new/copy/muteCopy返回对象的方法应该由谁管理内存?   AutoReleasePool也需要进行内存管理吗?如果要,谁来管理?    Chapter1 Life Before Automatic Reference Counting Reference Counted Memory Management Overview Memory">
<meta name="twitter:image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170706152431.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/07/06/Pro.Multithreading.and.Memory.ManageMent.for.iOS.and.OS.X/"/>





  <title>Pro.Multithreading.and.Memory.Management.for.iOS.and.OS.X(MRC和ARC) | Samuel blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Samuel blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">SamuelChan</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/06/Pro.Multithreading.and.Memory.ManageMent.for.iOS.and.OS.X/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="SamuelChan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170719163750.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Samuel blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Pro.Multithreading.and.Memory.Management.for.iOS.and.OS.X(MRC和ARC)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-06T14:56:56+08:00">
                2017-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Objective-C/" itemprop="url" rel="index">
                    <span itemprop="name">Objective-C</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/07/06/Pro.Multithreading.and.Memory.ManageMent.for.iOS.and.OS.X/" class="leancloud_visitors" data-flag-title="Pro.Multithreading.and.Memory.Management.for.iOS.and.OS.X(MRC和ARC)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>Problems:  </p>
<ol>
<li>一个非alloc/new/copy/muteCopy返回对象的方法应该由谁管理内存?  </li>
<li>AutoReleasePool也需要进行内存管理吗?如果要,谁来管理?</li>
</ol>
</blockquote>
<hr>
<h3 id="Chapter1-Life-Before-Automatic-Reference-Counting"><a href="#Chapter1-Life-Before-Automatic-Reference-Counting" class="headerlink" title="Chapter1 Life Before Automatic Reference Counting"></a>Chapter1 Life Before Automatic Reference Counting</h3><hr>
<h4 id="Reference-Counted-Memory-Management-Overview"><a href="#Reference-Counted-Memory-Management-Overview" class="headerlink" title="Reference Counted Memory Management Overview"></a>Reference Counted Memory Management Overview</h4><ol>
<li>Memory Management(means Reference Counting in OC) : a programmer allocates a memory area when the program needs it and frees it when the program no longer needs it.  </li>
<li>Reference Counting: invented by George E. Collins in 1960</li>
<li>With Reference Counting,you don’t need to remember the value of the reference counter itself or what refers to the object<br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170706152431.png" alt="SamuelChan/20170706152431.png"></li>
</ol>
<h4 id="Exploring-Memory-Management-Further"><a href="#Exploring-Memory-Management-Further" class="headerlink" title="Exploring Memory Management Further"></a>Exploring Memory Management Further</h4><ol>
<li>Reference Counting Rules:<ul>
<li>You have ownership of any objects you create.</li>
<li>You can take ownership of an object using retain.</li>
<li>When no longer needed, you must relinquish ownership of an object you own.</li>
<li>You must not relinquish ownership of an object you don’t own.</li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th>Action for Objective-C Object</th>
<th>Objective-C Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Create and have ownership of it</td>
<td>alloc/new/copy/mutableCopy group</td>
</tr>
<tr>
<td>Take ownership of it</td>
<td>retain</td>
</tr>
<tr>
<td>Relinquish it</td>
<td>release</td>
</tr>
<tr>
<td>Dispose of it</td>
<td>dealloc</td>
</tr>
</tbody>
</table>
<blockquote>
<p>these method(alloc, retain, release, and dealloc) are not provided by the Objective-C language itself.They are features of the Foundation Framework as part of Cocoa Framework<br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170706154549.png" alt="SamuelChan/20170706154549.png"></p>
</blockquote>
<h5 id="You-Have-Ownership-of-Any-Objects-You-Create"><a href="#You-Have-Ownership-of-Any-Objects-You-Create" class="headerlink" title="You Have Ownership of Any Objects You Create"></a>You Have Ownership of Any Objects You Create</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// You create an object and have ownership.</span></div><div class="line"><span class="keyword">id</span> obj     = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="keyword">id</span> obj     = [<span class="built_in">NSObject</span> new];</div><div class="line"><span class="keyword">id</span> objNew1 = [obj <span class="keyword">copy</span>];<span class="comment">//NSCopying protocol:copyWithZone:</span></div><div class="line"><span class="keyword">id</span> objNew2 = [obj mutableCopy];<span class="comment">//NSMutableCopying protocol:mutableCopyWithZone:</span></div><div class="line"><span class="comment">//the naming convention is applied to:</span></div><div class="line">  allocMyObject newThatObject copyThis mutableCopyYourObject</div><div class="line"><span class="comment">//the naming convention is not applied to:</span></div><div class="line">  allocate  newer  copying  mutableCopyed</div></pre></td></tr></table></figure>
<h5 id="You-Can-Take-Ownership-of-an-Object-Using-retain"><a href="#You-Can-Take-Ownership-of-an-Object-Using-retain" class="headerlink" title="You Can Take Ownership of an Object Using retain"></a>You Can Take Ownership of an Object Using retain</h5><p>Sometimes methods that are not in the alloc/new/copy/mutableCopy method group return an object : you haven’t create it, so you don’t have ownership of it.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Obtain an object without creating it yourself or having ownership   </span></div><div class="line"></div><div class="line"><span class="keyword">id</span> obj = [<span class="built_in">NSMutableArray</span> array];</div><div class="line"><span class="comment">// The obtained object exists and you don’t have ownership of it,but you have a reference to NSMutableArray object.</span></div><div class="line"></div><div class="line">[obj <span class="keyword">retain</span>];</div><div class="line"><span class="comment">// The obtained object exists and you don’t have ownership of it.</span></div></pre></td></tr></table></figure>
<h5 id="When-No-Longer-Needed-You-Must-Relinquish-Ownership-of-an-Object-You-Own"><a href="#When-No-Longer-Needed-You-Must-Relinquish-Ownership-of-an-Object-You-Own" class="headerlink" title="When No Longer Needed, You Must Relinquish Ownership of an Object You Own"></a>When No Longer Needed, You Must Relinquish Ownership of an Object You Own</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.alloc -&gt; relinquish</span></div><div class="line"><span class="comment">// You create an object and have ownership.</span></div><div class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="comment">// Now you have ownership of the object.</span></div><div class="line">[obj release];</div><div class="line"><span class="comment">// The object is relinquished.Though the variable obj has the pointer to the object,you can’t access the object anymore.</span></div><div class="line"></div><div class="line"><span class="comment">// 2.retain -&gt; relinquish</span></div><div class="line"><span class="comment">// Obtain an object without creating it yourself or having ownership</span></div><div class="line"><span class="keyword">id</span> obj = [<span class="built_in">NSMutableArray</span> array];</div><div class="line"><span class="comment">// The obtained object exists and you don’t have ownership of it.</span></div><div class="line">[obj <span class="keyword">retain</span>];</div><div class="line"><span class="comment">// Now you have ownership of the object.</span></div><div class="line">[obj release];</div><div class="line"><span class="comment">// The object is relinquished.You can’t access the object anymore.</span></div></pre></td></tr></table></figure>
<p><strong>how a method return a created object?</strong></p>
<ol>
<li>alloc/new/copy/muteableCopy : <strong>If a method returns an object of which the methodhasownership,ownership is passed to the caller</strong></li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)allocObject &#123;</div><div class="line">  <span class="comment">// You create an object and have ownership.</span></div><div class="line">  <span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">  <span class="comment">// At this moment, this method has ownership of the object.</span></div><div class="line">  <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>[NSMutableArray array] : Returning a New Object Without Ownership.<strong>By calling autorelease, you can return the created object without ownership</strong> 可以返回,而不是为什么要返回没有ownership的(means by design)</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)object &#123;</div><div class="line">  <span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">  <span class="comment">/* At this moment, this method has ownership of the object. */</span></div><div class="line"></div><div class="line">  [obj autorelease];</div><div class="line">  <span class="comment">/* The object exists, and you don’t have ownership of it. */</span></div><div class="line">  <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170706173000.png" alt="SamuelChan/20170706173000.png"></p>
<h5 id="You-Must-Not-Relinquish-Ownership-of-an-Object-You-Don’t-Own"><a href="#You-Must-Not-Relinquish-Ownership-of-an-Object-You-Don’t-Own" class="headerlink" title="You Must Not Relinquish Ownership of an Object You Don’t Own"></a>You Must Not Relinquish Ownership of an Object You Don’t Own</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">[obj release];</div><div class="line">[obj release];<span class="comment">//crash</span></div><div class="line"></div><div class="line"><span class="keyword">id</span> obj1 = [obj0 object];</div><div class="line">[obj1 release];<span class="comment">//crash sooner or later</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/** why retainCount = -1 ? */</span></div><div class="line"><span class="keyword">id</span> obj2 = [<span class="built_in">NSArray</span> array];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%ld"</span>,[obj2 retainCount]);</div><div class="line"></div><div class="line"><span class="keyword">id</span> obj4 = [<span class="built_in">NSString</span> string];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%ld"</span>,[obj4 retainCount]);</div></pre></td></tr></table></figure>
<h4 id="Implementing-alloc-retain-release-and-dealloc"><a href="#Implementing-alloc-retain-release-and-dealloc" class="headerlink" title="Implementing alloc, retain, release, and dealloc"></a>Implementing alloc, retain, release, and dealloc</h4><p>Although opensourced, I think this <code>guess</code> procedure still worth of being read so HERE WE GO.  </p>
<ol>
<li><del> But still, without having the implementation of NSObject itself, it is hard to see the whole picture </del>  :   <a href="https://github.com/opensource-apple/objc4" target="_blank" rel="external">NSObject has been opensource</a>  </li>
<li>CFFoundation is open-source,and the source code for memory management that is used from NSObject is public  </li>
<li><a href="https://en.wikipedia.org/wiki/GNUstep" target="_blank" rel="external">GNUstep</a> is a free software implementation of the Cocoa (formerly OpenStep) Objective-C frameworks, widget toolkit, and application development tools for Unix-like operating systems and Microsoft Windows. It is part of the GNU Project.Although we can’t expect it to be exactly the same as Apple’s implementation, it works in the same manner and the implementation should be similar.<strong>Understanding GNUstep source code helps us guess Apple’s Cocoa implementation</strong></li>
</ol>
<h5 id="GNUStep-implementation"><a href="#GNUStep-implementation" class="headerlink" title="GNUStep implementation"></a>GNUStep implementation</h5><p>1.The alloc Method</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> obj_layout &#123;</div><div class="line">	<span class="built_in">NSUInteger</span> retained;</div><div class="line">&#125;;</div><div class="line">+ (<span class="keyword">id</span>) alloc &#123;</div><div class="line">	<span class="keyword">int</span> size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> obj_layout) + size_of_the_object;</div><div class="line">	<span class="comment">//在堆上，分配n*size个字节，并初始化为0，返回void* 类型</span></div><div class="line">	<span class="keyword">struct</span> obj_layout *p = (<span class="keyword">struct</span> obj_layout *)calloc(<span class="number">1</span>, size);</div><div class="line">	<span class="keyword">return</span> (<span class="keyword">id</span>)(p + <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.The retain Method<br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707105639.png" alt="SamuelChan/20170707105639.png"></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSUInteger</span>) retainCount &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">NSExtraRefCount</span>(<span class="keyword">self</span>) + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">inline</span> <span class="built_in">NSUInteger</span> <span class="built_in">NSExtraRefCount</span>(<span class="keyword">id</span> anObject)&#123;</div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">struct</span> obj_layout *)anObject)[<span class="number">-1</span>].retained; <span class="comment">//移到头部</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>) <span class="keyword">retain</span> &#123;</div><div class="line">    <span class="built_in">NSIncrementExtraRefCount</span>(<span class="keyword">self</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="built_in">NSIncrementExtraRefCount</span>(<span class="keyword">id</span> anObject) &#123;   <span class="keyword">if</span> (((<span class="keyword">struct</span> obj_layout *)anObject)[<span class="number">-1</span>].retained == <span class="built_in">UINT_MAX</span> - <span class="number">1</span>)   [<span class="built_in">NSException</span> raise: <span class="built_in">NSInternalInconsistencyException</span> format: <span class="string">@"NSIncrementExtraRefCount() asked increment too far"</span>];   ((<span class="keyword">struct</span> obj_layout *)anObject)[<span class="number">-1</span>].retained++;&#125;</div></pre></td></tr></table></figure>
<p>3.The release Method</p>
<pre><code class="objc">- (<span class="keyword">void</span>) release {
  <span class="keyword">if</span> (<span class="built_in">NSDecrementExtraRefCountWasZero</span>(<span class="keyword">self</span>))
  [<span class="keyword">self</span> dealloc]; <span class="comment">//dispose it</span>
}

<span class="built_in">BOOL</span> <span class="built_in">NSDecrementExtraRefCountWasZero</span>(<span class="keyword">id</span> anObject) {
  <span class="keyword">if</span> (((<span class="keyword">struct</span> obj_layout *)anObject)[<span class="number">-1</span>].retained == <span class="number">0</span>) {
    <span class="keyword">return</span> <span class="literal">YES</span>;
  } <span class="keyword">else</span> {
    ((<span class="keyword">struct</span> obj_layout *)anObject)[<span class="number">-1</span>].retained--;
    <span class="keyword">return</span> <span class="literal">NO</span>;
  }
}
</code></pre>
<p>4.The dealloc Method</p>
<pre><code class="objc">- (<span class="keyword">void</span>) dealloc {
  <span class="built_in">NSDeallocateObject</span> (<span class="keyword">self</span>);
}

<span class="keyword">inline</span> <span class="keyword">void</span> <span class="built_in">NSDeallocateObject</span>(<span class="keyword">id</span> anObject) {
  <span class="keyword">struct</span> obj_layout *o = &amp;((<span class="keyword">struct</span> obj_layout *)anObject)[<span class="number">-1</span>];
  free(o);
}
</code></pre>
<h5 id="Apple’s-Implementation-of-alloc-retain-release-and-dealloc"><a href="#Apple’s-Implementation-of-alloc-retain-release-and-dealloc" class="headerlink" title="Apple’s Implementation of alloc, retain, release, and dealloc"></a>Apple’s Implementation of alloc, retain, release, and dealloc</h5><p>1.The alloc method</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">+alloc</div><div class="line">+allocWithZone:</div><div class="line">class_createInstance</div><div class="line">calloc</div></pre></td></tr></table></figure>
<p>2.retainCount, retain, and release</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">-retainCount</div><div class="line">__CFDoExternRefOperation</div><div class="line"><span class="built_in">CFBasicHashGetCountOfKey</span></div><div class="line"></div><div class="line">-<span class="keyword">retain</span></div><div class="line">__CFDoExternRefOperation</div><div class="line"><span class="built_in">CFBasicHashAddValue</span></div><div class="line"></div><div class="line">-release</div><div class="line">__CFDoExternRefOperation</div><div class="line"><span class="built_in">CFBasicHashRemoveValue</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> __CFDoExternRefOperation(uintptr_t op, <span class="keyword">id</span> obj) &#123;</div><div class="line">  	<span class="built_in">CFBasicHashRef</span> table = get hashtable from obj;</div><div class="line">    <span class="keyword">int</span> count;</div><div class="line">    <span class="keyword">switch</span> (op) &#123;</div><div class="line">      <span class="keyword">case</span> OPERATION_retainCount:</div><div class="line">        count = <span class="built_in">CFBasicHashGetCountOfKey</span>(table, obj);</div><div class="line">        <span class="keyword">return</span> count;</div><div class="line">      <span class="keyword">case</span> OPERATION_retain:</div><div class="line">        <span class="built_in">CFBasicHashAddValue</span>(table, obj);</div><div class="line">        <span class="keyword">return</span> obj;</div><div class="line">      <span class="keyword">case</span> OPERATION_release:</div><div class="line">        count = <span class="built_in">CFBasicHashRemoveValue</span>(table, obj);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span> == count;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSUInteger</span>) retainCount &#123;</div><div class="line">  	<span class="keyword">return</span> (<span class="built_in">NSUInteger</span>)__CFDoExternRefOperation(OPERATION_retainCount, <span class="keyword">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>) <span class="keyword">retain</span> &#123;</div><div class="line">  <span class="keyword">return</span> (<span class="keyword">id</span>)__CFDoExternRefOperation(OPERATION_retain, <span class="keyword">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>) release &#123;</div><div class="line">  <span class="keyword">return</span> __CFDoExternRefOperation(OPERATION_release, <span class="keyword">self</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.Apple implementation vs GNUStep implementation<br>Benefits:<br>GNUStep implementation:    </p>
<ul>
<li>Fewer codes  </li>
<li>It is quite simple to manage the lifetime, because each memory area of the reference count itself is included in the object memory area</li>
</ul>
<p>Apple implementation:</p>
<ul>
<li>Each object doesn’t have a header, thus there is no need to worry about alignment issues for the header area</li>
<li>By iterating through the hash table entries, memory blocks for each object are reachable.(useful for debugging,LLDB and Instruments)</li>
</ul>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707113104.png" alt="SamuelChan/20170707113104.png"><br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707113946.png" alt="SamuelChan/20170707113946.png"></p>
<h4 id="Autorelease"><a href="#Autorelease" class="headerlink" title="Autorelease"></a>Autorelease</h4><p>1.Automatic Variables in C language:when left the variable scope,auto variable ‘int a’ is disposed of and can’t be accessed anymore.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> a;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.autoRelease:when execution leaves a code block, the “release” method is called on the object automatically</p>
<p>3.Caution:<br>(1)临时处理多个对象的释放<br>(2)类方法返回来一个没有ownership的对象<br>(3)不要对NSAutoReleasePool发送autoRelease方法,因为它已经被override抛出exception  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//1. Create an NSAutoreleasePool object.</span></div><div class="line"><span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</div><div class="line"></div><div class="line"><span class="comment">//2. Call “autorelease” to allocated objects.</span></div><div class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">[obj autorelease];</div><div class="line"></div><div class="line"><span class="comment">//3. Discard the NSAutoreleasePool object.</span></div><div class="line">[pool drain];<span class="comment">//will do [obj release]</span></div></pre></td></tr></table></figure>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707141849.png" alt="SamuelChan/20170707141849.png">  </p>
<p>No need to explicitly use the NSAutoreleasePool object in <code>the main Runloop</code>  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170707142124.png" alt="SamuelChan/20170707142124.png">  </p>
<h5 id="Implementing-autorelease"><a href="#Implementing-autorelease" class="headerlink" title="Implementing autorelease"></a>Implementing autorelease</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoreleasePoolPage</span> &#123;</span></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">push</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">/* It corresponds to creation and ownership of an NSAutoreleasePool object */</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">void</span> *token)</span> </span>&#123;</div><div class="line">    <span class="comment">/* It corresponds to disposal of an NSAutoreleasePool object */</span></div><div class="line">    releaseAll();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> id <span class="title">autorelease</span><span class="params">(id obj)</span> </span>&#123;</div><div class="line">    <span class="comment">/* It corresponds to NSAutoreleasePool class method addObject. */</span></div><div class="line">    AutoreleasePoolPage *autoreleasePoolPage = <span class="comment">/* getting active 	AutoreleasePoolPage object */</span></div><div class="line">    autoreleasePoolPage-&gt;add(obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function">id *<span class="title">add</span><span class="params">(id obj)</span> </span>&#123;</div><div class="line">    <span class="comment">/* add the obj to an internal array; */</span> &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">releaseAll</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">/* calls release for all the objects in the internal array */</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">objc_autoreleasePoolPush</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> AutoreleasePoolPage::push();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_autoreleasePoolPop</span><span class="params">(<span class="keyword">void</span> *ctxt)</span> </span>&#123;</div><div class="line">  AutoreleasePoolPage::pop(ctxt);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">id <span class="title">objc_autorelease</span><span class="params">(id obj)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> AutoreleasePoolPage::autorelease(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Chapter2-ARC-Rules"><a href="#Chapter2-ARC-Rules" class="headerlink" title="Chapter2 ARC Rules"></a>Chapter2 ARC Rules</h3><blockquote>
<p>Apple: Automatic Reference Counting (ARC) in Objective-C makes memory management the job of the compiler. By enabling ARC with the new Apple LLVM compiler, you will never need to type retain or release again, dramatically simplifying the development process, while reducing crashes and memory leaks. The compiler has a complete understanding of your objects, and releases each object the instant it is no longer used, so apps run as fast as ever, with predictable, smooth performance.1</p>
</blockquote>
<p>ARC related:</p>
<ul>
<li>iOS 5 2011  </li>
<li>Xcode Version &gt;= 4.2  </li>
<li>LLVM version  &gt;= 3.0  </li>
<li>Objective-C runtime library: objc4 493.9 or later</li>
<li>ARC enabled: 1.Enabled ARC in build Setting 2.部分MRC:Build phases→Compile Sources→ -fno-objc-arc 3. Build phases→Compile Sources→部分ARC:-fobjc-arc<br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717103437.png" alt="SamuelChan/20170717103437.png"></li>
</ul>
<p>Chapter2组织方式:  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- the relationship of the reference counting rules with ARC  </div><div class="line">- the ownership specifiers one by one  </div><div class="line">- we learn the rules to make your code ARC-friendly: by simply following the rules</div></pre></td></tr></table></figure>
<h4 id="Ownership-qualifiers"><a href="#Ownership-qualifiers" class="headerlink" title="Ownership qualifiers"></a>Ownership qualifiers</h4><blockquote>
<p>With ARC,, ‘id’ and object type variables <mark><strong>must</strong></mark> have one of the following four ownership qualifiers:</p>
</blockquote>
<ul>
<li>__strong  </li>
<li>__weak  </li>
<li>__unsafe _unretained     </li>
<li>__autoreleasing</li>
</ul>
<h5 id="1-strong-ownership-qualifier"><a href="#1-strong-ownership-qualifier" class="headerlink" title="1.__strong ownership qualifier"></a>1.__strong ownership qualifier</h5><ul>
<li><p>__strong 代表了对象的ownership (MRC下对象需要通过alloc/new/copy/muteableCopy或者retain来获得ownership)</p>
</li>
<li><p>__strong离开了{ }之后就会消失,即是说作用域在{ }之间</p>
</li>
<li><p>一个对象没有ownership将会被disposed</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* non-ARC */</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">  [obj release];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* ARC */</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ownership is properly managed not only by variable scope, but also by assignments between variables</span></div><div class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> obj0 = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> obj1 = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> obj2 = <span class="literal">nil</span>;</div><div class="line">obj0 = obj1;</div><div class="line">obj2 = obj0;</div><div class="line">obj1 = <span class="literal">nil</span>;</div><div class="line">obj0 = <span class="literal">nil</span>;</div><div class="line">obj2 = <span class="literal">nil</span>;</div><div class="line"></div><div class="line"><span class="comment">//By the way, any variables that are qualified with __strong, __weak, and __autoreleasing, are initialized with nil</span></div><div class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> obj0;</div><div class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1;</div><div class="line"><span class="keyword">id</span> __autoreleasing obj2;</div><div class="line">The above source code is equivalent to the following.</div><div class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> obj0 = <span class="literal">nil</span>;</div><div class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = <span class="literal">nil</span>;</div><div class="line"><span class="keyword">id</span> __autoreleasing obj2 = <span class="literal">nil</span>;</div></pre></td></tr></table></figure>
<h5 id="2-weak-ownership-qualifier"><a href="#2-weak-ownership-qualifier" class="headerlink" title="2.__weak ownership qualifier"></a>2.__weak ownership qualifier</h5><blockquote>
<p>solve circular reference,self reference: A weak reference does not have ownership of the object.</p>
<p>When a variable has a reference to an object and the object is discarded, the weak reference also disappears automatically, which means that the variable is assigned to <mark>nil</mark>.</p>
</blockquote>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170711111007.png" alt="SamuelChan/20170711111007.png"></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj = [[<span class="built_in">NSObject</span> alloc] init];<span class="comment">//wrong,</span></div><div class="line"><span class="comment">//warning: assigning retained obj to weak variable; obj will be released after assignment [-Warc-unsafe-retained-assign]</span><span class="keyword">id</span> __<span class="keyword">strong</span> obj0 = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj0;</div></pre></td></tr></table></figure>
<h5 id="3-unsafe-unretained-ownership-qualifier"><a href="#3-unsafe-unretained-ownership-qualifier" class="headerlink" title="3.__unsafe_unretained ownership qualifier"></a>3.__unsafe_unretained ownership qualifier</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">weak</span>               : iOS5 (or later) or OSX Lion (or later)</div><div class="line">__unsafe _unretained : before iOS5 or before OSX Lion</div><div class="line"></div><div class="line"><span class="comment">//__weak和__unsafe_unretained的区别在于:后者不会在对象无ownership之后自动置为nil</span></div><div class="line"><span class="keyword">id</span> __<span class="keyword">unsafe_unretained</span> obj1 = <span class="literal">nil</span>;</div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">strong</span> obj0 = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">  obj1 = obj0;</div><div class="line">  <span class="built_in">NSLog</span>(<span class="string">@"A: %@"</span>, obj1);</div><div class="line">&#125;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"B: %@"</span>, obj1);<span class="comment">//Crash:野指针,访问僵尸对象,报EXC_BAD_ADDRESS</span></div><div class="line"></div><div class="line">FYI:</div><div class="line">（<span class="number">1</span>）野指针</div><div class="line">①C语言:定义了一个指针变量，但是并没有赋初值，它随机指向一个东西</div><div class="line">②Obj某指针变量指向的内存空间被释放掉了（指向僵尸对象的指针）</div><div class="line"></div><div class="line">（<span class="number">2</span>）僵尸对象</div><div class="line">已经被销毁的对象（无法被使用的对象）</div><div class="line"></div><div class="line">（<span class="number">3</span>）空指针</div><div class="line">没有指向存储空间的指针（里面存的是<span class="literal">nil</span>，也就是<span class="number">0</span>）</div><div class="line">给空指针发消息是没有任何反应的，不会提示出错</div><div class="line"></div><div class="line">(<span class="number">4</span>) EXC_BAD_ADDRESS ARC什么时候会出现?? Core-Foundation,混编,C++</div></pre></td></tr></table></figure>
<h5 id="4-autoreleasing-ownership-qualifier"><a href="#4-autoreleasing-ownership-qualifier" class="headerlink" title="4.__autoreleasing ownership qualifier"></a>4.__autoreleasing ownership qualifier</h5><p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170711144133.png" alt="SamuelChan/20170711144133.png"><br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170711144249.png" alt="SamuelChan/20170711144249.png"></p>
<ul>
<li><p>①When an object is returned from a method, the compiler checks if the method begins with alloc/new/copy/mutableCopy, and if not, the returned object is automatically registered to the autorelease pool</p>
</li>
<li><p>②Exceptionally, any method whose name begins with init, doesn’t register the return value to autoreleasepool</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@autoreleasepool</span> &#123;</div><div class="line"><span class="comment">//not in the alloc/new/copy/mutableCopy method group,register in autoReleasePool</span>	<span class="keyword">id</span> __<span class="keyword">strong</span> obj = [<span class="built_in">NSMutableArray</span> array];&#125;</div><div class="line"></div><div class="line"><span class="comment">//“id obj” does not have a qualifier. So it is qualified with __strong. When the “return” sentence is executed, the variable scope is left and the strong reference disappears. Therefore the object will be released automatically. Before that, if the compiler detects that the object will be passed to the caller, the object is registered in autoreleasepool.</span></div><div class="line"></div><div class="line">+ (<span class="keyword">id</span>) array &#123;</div><div class="line">  <span class="keyword">id</span> obj = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">  <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>③<del>the <strong>weak ownership qualifier is used to avoid cyclic reference. When a variable with a </strong>weak qualifier is used, the object is always registered in autoreleasepool.</del>  </p>
<p>  <del> Why does the object need to be registered in autoreleasepool in order to use the object via the <strong>weak qualified variable? Because a variable, which is qualified with </strong>weak,<br>does not have a strong reference, the object might be disposed of at any point. If the object is registered in autoreleasepool, until @autoreleasepool block is left, the object must exist. So, to use the objects via __weak variable safely, the object is registered in autoreleasepool automatically.(<strong>to be proved</strong>) </del></p>
</li>
<li><p>④ Any pointers to ‘id’ or object types are qualified with __autoreleasing as default.  </p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> obj 	       == <span class="keyword">id</span> __<span class="keyword">strong</span> obj;  </div><div class="line"><span class="keyword">id</span> *obj   	   == <span class="keyword">id</span> __autoreleasing *obj;  </div><div class="line"><span class="built_in">NSObject</span> **obj == <span class="built_in">NSObject</span> * __autoreleasing *obj  </div><div class="line">-(<span class="built_in">BOOL</span>) performOperationWithError:(<span class="built_in">NSError</span> * __autoreleasing *)error;</div></pre></td></tr></table></figure>
<p>5.Returning a Result as the Argument</p>
<blockquote>
<p>The caller will obtain the object as an argument, which means that the caller does not obtain it from the alloc/new/copy/mutableCopy method group. To follow the memory management rules, <mark>when you do not obtain an object by the alloc/new/copy/mutableCopy method group, the object has to be passed without ownership.</mark> By the __autoreleasing ownership qualifier, the rule is fulfilled.</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>) performOperationWithError:(<span class="built_in">NSError</span> * __autoreleasing *)error &#123;</div><div class="line">  <span class="comment">/* Error occurred. Set errorCode */</span></div><div class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//To assign an object pointer, both ownership qualifiers have to be the same.</span></div><div class="line"><span class="built_in">NSError</span> __autoreleasing *error = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">NSError</span> * __autoreleasing *pError = &amp;error; <span class="comment">/* No compile error */</span></div><div class="line"></div><div class="line"><span class="comment">//compile optimization(before)</span></div><div class="line"><span class="built_in">NSError</span> __<span class="keyword">strong</span> *error = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">BOOL</span> result = [obj performOperationWithError:&amp;error];</div><div class="line"></div><div class="line"><span class="comment">//compile optimization(after)</span></div><div class="line"><span class="built_in">NSError</span> __<span class="keyword">strong</span> *error = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">NSError</span> __autoreleasing *tmp = error;</div><div class="line"><span class="built_in">BOOL</span> result = [obj performOperationWithError:&amp;tmp];</div><div class="line">error = tmp;</div></pre></td></tr></table></figure>
<h4 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span>Forget about using <span class="keyword">retain</span>, release, retainCount, and autorelease.</div><div class="line"><span class="number">2.</span>Forget about using <span class="built_in">NSAllocateObject</span> and <span class="built_in">NSDeallocateObject</span>.</div><div class="line"><span class="number">3.</span>Follow the naming rule <span class="keyword">for</span> methods related to object creation:</div><div class="line">  create ownership:alloc/new/<span class="keyword">copy</span>/mutableCopy/- (instanceType)initWithXXX</div><div class="line"><span class="number">4.</span>Forget about calling dealloc explicitly.</div><div class="line">  dealloc is a suitable place to remove the object from delegate or observers</div><div class="line"><span class="number">5.</span>Use <span class="keyword">@autoreleasepool</span> instead of <span class="built_in">NSAutoreleasePool</span>.</div><div class="line"><span class="number">6.</span>Forget about using Zone (<span class="built_in">NSZone</span>)</div><div class="line">  现在CPU的负载能力不需要<span class="built_in">NSZone</span>这种会带来碎片化的机制</div><div class="line"><span class="number">7.</span>Object type variables can’t be members of <span class="keyword">struct</span> or <span class="keyword">union</span> <span class="keyword">in</span> C language.</div></pre></td></tr></table></figure>
<p>8.‘id’ and ‘void<em>’ have to be cast explicitly.<br>With ARC,To cast between ‘id’ or object types and ‘void</em>‘,you can use __bridge</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//dangerous: should be careful,since you don't know whether p have ownership or not.</span></div><div class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];   </div><div class="line"><span class="keyword">void</span> *p = (__bridge <span class="keyword">void</span> *)obj;</div><div class="line"><span class="keyword">id</span> o = (__bridge <span class="keyword">id</span>)p;</div><div class="line"></div><div class="line"><span class="comment">//__bridge dangling pointer example</span></div><div class="line"><span class="keyword">void</span> *p = <span class="literal">nil</span>;</div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> obj = [<span class="built_in">NSObject</span> new];</div><div class="line">  p = (__bridge <span class="keyword">void</span> *)obj;</div><div class="line">&#125;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,(__bridge <span class="keyword">id</span>)p);<span class="comment">//错误,野指针</span></div></pre></td></tr></table></figure>
<p><code>__bridge_retained</code> 和 <code>__bridge_transfer</code> 都是用来解决<code>void *</code>的ownership的</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//__bridge_retained:__bridge_retained cast works as if the assigned variable has ownership of the object</span></div><div class="line"><span class="comment">//example 1</span></div><div class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="keyword">void</span> *p = (__bridge_retained <span class="keyword">void</span> *)obj;<span class="comment">//pointer p也有ownership</span></div><div class="line"></div><div class="line"><span class="comment">//example 2</span></div><div class="line"><span class="keyword">void</span> *p = <span class="number">0</span>;</div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">  p = (__bridge_retained <span class="keyword">void</span> *)obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"class=%@"</span>, [(__bridge <span class="keyword">id</span>)p <span class="keyword">class</span>]);<span class="comment">//after leave the scrope variable, p still have ownership</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//__bridge_transfer:__bridge_transfer cast will release the object just after the assignment is done.</span></div><div class="line"><span class="comment">//example 1</span></div><div class="line"><span class="keyword">id</span> obj = (__bridge_transfer <span class="keyword">id</span>)p;</div><div class="line"></div><div class="line"><span class="comment">//example 2</span></div><div class="line"><span class="keyword">void</span> *p = (__bridge_retained <span class="keyword">void</span> *)[[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"class=%@"</span>, [(__bridge <span class="keyword">id</span>)p <span class="keyword">class</span>]);</div><div class="line">(<span class="keyword">void</span>)(__bridge_transfer <span class="keyword">id</span>)p;</div></pre></td></tr></table></figure>
<h5 id="Core-Foundation"><a href="#Core-Foundation" class="headerlink" title="Core Foundation"></a>Core Foundation</h5><blockquote>
<p>iOS的系统架构分为四个层次：核心操作系统层（Core OS layer）、核心服务层（Core Services layer）、媒体层（Media layer）和可触摸层（Cocoa Touch layer）。Core Foundation框架 (CoreFoundation.framework) 是一组C语言接口，它们为iOS应用程序提供基本数据管理和服务功能。位于第二层核心服务层<br>cocoa Foundation框架位于第四层。<br><a href="https://developer.apple.com/library/content/documentation/CoreFoundation/Conceptual/CFDesignConcepts/CFDesignConcepts.html#//apple_ref/doc/uid/10000122i" target="_blank" rel="external">CoreFoundation</a></p>
</blockquote>
<p>OBJECTIVE-C OBJECT AND CORE FOUNDATION OBJECT<br>1.Core Foundation,mainly written in C;has reference counting<br>2.<a href="https://developer.apple.com/library/content/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html#//apple_ref/doc/uid/TP40010677-SW1" target="_blank" rel="external">Toll-Free Bridged Types</a>:There are a number of data types in the Core Foundation framework and the Foundation framework that can be used interchangeably. Data types that can be used interchangeably are also referred to as toll-free bridged data types</p>
<p>CFBridgingRetain function</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFTypeRef</span> <span class="built_in">CFBridgingRetain</span>(<span class="keyword">id</span> X) &#123;</div><div class="line">  <span class="keyword">return</span> (__bridge_retained <span class="built_in">CFTypeRef</span>)X;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFMutableArrayRef</span> cfObject = <span class="literal">NULL</span>;</div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> obj = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">  cfObject = <span class="built_in">CFBridgingRetain</span>(obj);<span class="comment">//warning...</span></div><div class="line">  <span class="comment">//cfObject =  (__bridge_retained CFMutableArrayRef)obj;//no warning</span></div><div class="line">  <span class="built_in">CFShow</span>(cfObject);</div><div class="line">  printf(<span class="string">"retain count = %d\n"</span>, <span class="built_in">CFGetRetainCount</span>(cfObject));</div><div class="line">&#125;</div><div class="line">printf(<span class="string">"retain count after the scope = %d\n"</span>, 	<span class="built_in">CFGetRetainCount</span>(cfObject)); <span class="built_in">CFRelease</span>(cfObject);</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFMutableArrayRef</span> cfObject = <span class="built_in">CFArrayCreateMutable</span>(kCFAllocatorDefault, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">printf(<span class="string">"retain count = %d\n"</span>, <span class="built_in">CFGetRetainCount</span>(cfObject));</div><div class="line"><span class="keyword">id</span> obj = <span class="built_in">CFBridgingRelease</span>(cfObject);</div><div class="line">printf(<span class="string">"retain count after the cast = %d\n"</span>,<span class="built_in">CFGetRetainCount</span>(cfObject));</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"class=%@"</span>, obj);</div></pre></td></tr></table></figure>
<h4 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h4><table>
<thead>
<tr>
<th>Property modifier</th>
<th>Ownership qualifier</th>
</tr>
</thead>
<tbody>
<tr>
<td>assign</td>
<td>__unsafe _unretained</td>
</tr>
<tr>
<td>copy</td>
<td>__strong (note: new copied object is assigned.)</td>
</tr>
<tr>
<td>retain</td>
<td>__strong</td>
</tr>
<tr>
<td>strong</td>
<td>__strong</td>
</tr>
<tr>
<td>unsafe_unretained</td>
<td>__unsafe _unretained</td>
</tr>
<tr>
<td>weak</td>
<td>__weak  </td>
</tr>
</tbody>
</table>
<h3 id="Chapter-3-ARC-implementation"><a href="#Chapter-3-ARC-implementation" class="headerlink" title="Chapter 3 ARC implementation"></a>Chapter 3 ARC implementation</h3><hr>
<h4 id="strong"><a href="#strong" class="headerlink" title="__strong"></a>__strong</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* pseudo code by the compiler */</span></div><div class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="keyword">@selector</span>(alloc));</div><div class="line">objc_msgSend(obj, <span class="keyword">@selector</span>(init));</div><div class="line">objc_release(obj);</div></pre></td></tr></table></figure>
<p>an object is not obtained by the alloc/new/copy/mutableCopy</p>
<p>objc_retainAutoreleasedReturnValue:  </p>
<ol>
<li><strong><code>objc_retainAutoreleasedReturnValue</code></strong> function is for performance optimization. It is inserted because the NSMutableArray class method array is not in the alloc/new/copy/mutableCopy method group. <code>The compiler</code> inserts this function every time just after the invocation of a method if the method is not in the group. As the name suggests, it <code>retains</code> an object returned from a method or function after <code>the object is added in autorelease pool</code>.  </li>
<li><strong><code>objc_retainAutoreleasedReturnValue</code></strong> function expects that an <strong><code>objc_autoreleaseReturnValue</code></strong> function has been called inside the method. Any methods, that are not in the alloc/new/copy/mutableCopy group, have to call <strong><code>objc_autoreleaseReturnValue</code></strong></li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* pseudo code by the compiler */</span></div><div class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSMutableArray</span>, <span class="keyword">@selector</span>(array));</div><div class="line">objc_retainAutoreleasedReturnValue(obj);</div><div class="line">objc_release(obj);</div></pre></td></tr></table></figure>
<p>objc_autoreleaseReturnValue</p>
<ol>
<li><code>objc_autoreleaseReturnValue</code> adds an object to autorelease pool and returns it</li>
<li><code>objc_autoreleaseReturnValue</code> checks <code>the caller’s executable code</code> and if the code calls <code>objc_retainAutoreleasedReturnValue</code> just after calling this method: <strong>it just returns the object to the caller,So, performance will be improved.</strong><blockquote>
<p>返回值身上调用objc_autoreleaseReturnValue方法时，runtime将这个返回值object储存在TLS中，然后直接返回这个object（不调用autorelease）；同时，在外部接收这个返回值的objc_retainAutoreleasedReturnValue里，发现TLS中正好存了这个对象，那么直接返回这个object（不调用retain）。于是乎，调用方和被调方利用TLS做中转，很有默契的免去了对返回值的内存管理。<mark>即是说如果确认方法返回值一定会被其他引用持有的话,那么就不需要放进缓存池</mark></p>
</blockquote>
</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">id</span>) array &#123;</div><div class="line">  <span class="keyword">return</span> [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line">This source code is converted as follows. It calls objc_autoreleaseReturnValue function at the last.</div><div class="line"><span class="comment">/* pseudo code by the compiler */</span></div><div class="line">+ (<span class="keyword">id</span>) array</div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSMutableArray</span>, <span class="keyword">@selector</span>(alloc));</div><div class="line">  objc_msgSend(obj, <span class="keyword">@selector</span>(init));</div><div class="line">  <span class="keyword">return</span> objc_autoreleaseReturnValue(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170713155559.png" alt="SamuelChan/20170713155559.png"></p>
<h4 id="weak"><a href="#weak" class="headerlink" title="__weak"></a>__weak</h4><ul>
<li>Nil is assigned to any variables qualified with __weak when referencing object is discarded.</li>
<li><del> When an object is accessed through a __weak qualified variable, the object is added to the autorelease pool:</del> wrong guide</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* example */</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj;</div><div class="line">&#125;</div><div class="line"><span class="comment">/* pseudo code by the compiler */</span></div><div class="line"><span class="keyword">id</span> obj1;</div><div class="line">objc_initWeak(&amp;obj1, obj); <span class="comment">//call obj1 = 0; objc_storeWeak(&amp;obj1, obj);</span></div><div class="line">objc_destroyWeak(&amp;obj1);   <span class="comment">//call objc_storeWeak(&amp;obj1, 0);</span></div></pre></td></tr></table></figure>
<blockquote>
<p><code>Hash table</code> : 我们知道，数组的最大特点就是：寻址容易，插入和删除困难；而链表正好相反，寻址困难，而插入和删除操作容易。那么如果能够结合两者的优点，做出一种寻址、插入和删除操作同样快速容易的数据结构，那该有多好。这就是哈希表创建的基本思想，而实际上哈希表也实现了这样的一个“夙愿”，哈希表就是这样一个集查找、插入和删除操作于一身的数据结构。  </p>
</blockquote>
<p><code>objc_storeWeak</code>:  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This function stores a new value into a __weak variable. It would</div><div class="line"> * be used anywhere a __weak variable is the target of an assignment.</div><div class="line"> *</div><div class="line"> * @param location The address of the weak pointer itself</div><div class="line"> * @param newObj The new object this weak ptr should now point to</div><div class="line"> *</div><div class="line"> * @return \e newObj</div><div class="line"> */</div><div class="line"><span class="keyword">id</span> objc_storeWeak(<span class="keyword">id</span> *location, <span class="keyword">id</span> newObj)</div><div class="line"></div><div class="line"><span class="comment">//when obj = 0,the entry remove from hash table</span></div><div class="line">objc_storeWeak(&amp;obj1, obj);</div></pre></td></tr></table></figure>
<p><code>When an Object Is Discarded</code>  </p>
<ol>
<li>objc_release.</li>
<li>dealloc is called because retain count becomes zero.</li>
<li>_objc_rootDealloc.</li>
<li>object_dispose.</li>
<li>objc_destructInstance.</li>
<li>objc_clear_deallocating:<ol>
<li>From the weak table, get an entry of which the key is the object to be discarded.</li>
<li>Set nil to all the __weak ownership qualified variables in the entry.</li>
<li>Remove the entry from the table.</li>
<li>For the object to be disposed of, remove its <code>key</code> from the <strong><code>reference table</code></strong>.</li>
</ol>
</li>
</ol>
<p><code>Assigning a Newly Created Object</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">weak</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* pseudo code by the compiler */</span></div><div class="line"><span class="keyword">id</span> obj;</div><div class="line"><span class="keyword">id</span> tmp = objc_msgSend(<span class="built_in">NSObject</span>, <span class="keyword">@selector</span>(alloc));</div><div class="line">objc_msgSend(tmp, <span class="keyword">@selector</span>(init));</div><div class="line">objc_initWeak(&amp;obj, tmp);</div><div class="line">objc_release(tmp);</div><div class="line">objc_destroyWeak(&amp;object);</div></pre></td></tr></table></figure>
<p><strong><del>Adding to autorelease pool Automatically</del></strong><br>验证汇编代码: Xcode → Debug → Debug workflow → Always show Disassembly.<br>输入下面的例子,会看到编译器插入的是release不是autorelease</p>
<p>In conclusion, this design of <strong>weak ensure that during the usage of weak pointer, its state is consistent. The <code>new</code> implmenetation of </strong>weak of <code>Apple LLVM version 8.0.0 (clang-800.0.42.1)</code> do not postpond the release to autoreleasepool, but use <code>objc_release</code> <strong>directly</strong>.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj;</div><div class="line">  <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, obj1);</div><div class="line">&#125;</div><div class="line"><span class="comment">/* iOS5及之前编译器做法 */</span></div><div class="line"><span class="keyword">id</span> obj1;</div><div class="line">objc_initWeak(&amp;obj1, obj);</div><div class="line"><span class="keyword">id</span> tmp = objc_loadWeakRetained(&amp;obj1);</div><div class="line">objc_autorelease(tmp);<span class="comment">//错误!!!mistake</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, tmp);</div><div class="line">objc_destroyWeak(&amp;obj1);</div><div class="line"></div><div class="line"><span class="comment">/* 现在的编译器做法*/</span></div><div class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="string">"new"</span>);</div><div class="line"><span class="keyword">id</span> obj1;</div><div class="line">objc_initWeak(&amp;obj1, obj);</div><div class="line"><span class="keyword">id</span> tmp = objc_loadWeakRetained(obj1);<span class="comment">//objc_loadWeakRetained would increment the reference count to ensure that tmp is alive in the NSLog statement.</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, obj1);</div><div class="line">objc_release(tmp);</div><div class="line">objc_destroyWeak(&amp;obj1);</div><div class="line">objc_storeStrong(&amp;obj, <span class="number">0</span>);<span class="comment">//release</span></div></pre></td></tr></table></figure>
<p><a href="https://lists.apple.com/archives/objc-language/2012/Aug/msg00027.htm‌​l" target="_blank" rel="external">苹果list</a><br><a href="https://stackoverflow.com/questions/40993809/why-weak-object-will-be-added-to-autorelease-pool/41008619#41008619" target="_blank" rel="external">参考资料1</a><br><a href="https://stackoverflow.com/questions/34083137/objective-c-weak-object-is-registered-in-autoreleasepool-automatically?rq=1" target="_blank" rel="external">参考资料2</a></p>
<h4 id="autoreleasing"><a href="#autoreleasing" class="headerlink" title="__autoreleasing"></a>__autoreleasing</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">  <span class="keyword">id</span> __autoreleasing obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* pseudo code by the compiler */</span></div><div class="line"><span class="keyword">id</span> pool = objc_autoreleasePoolPush();</div><div class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="keyword">@selector</span>(alloc));</div><div class="line">objc_msgSend(obj, <span class="keyword">@selector</span>(init));  </div><div class="line">objc_autorelease(obj);    <span class="comment">//放进自动释放池</span></div><div class="line">objc_autoreleasePoolPop(pool);</div><div class="line"></div><div class="line"><span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">  <span class="keyword">id</span> __autoreleasing obj = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* pseudo code by the compiler */</span></div><div class="line"><span class="keyword">id</span> pool = objc_autoreleasePoolPush();</div><div class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSMutableArray</span>, <span class="keyword">@selector</span>(array));</div><div class="line">objc_retainAutoreleasedReturnValue(obj);</div><div class="line">objc_autorelease(obj);</div><div class="line">objc_autoreleasePoolPop(pool);</div></pre></td></tr></table></figure>
<h4 id="Reference-Count"><a href="#Reference-Count" class="headerlink" title="Reference Count"></a>Reference Count</h4><p><code>uintptr_t _objc_rootRetainCount(id obj)</code>:don’t return reliable value all the time</p>
<h3 id="NSObject开源release-retain-dealloc内存管理的实现"><a href="#NSObject开源release-retain-dealloc内存管理的实现" class="headerlink" title="NSObject开源release,retain,dealloc内存管理的实现"></a>NSObject开源release,retain,dealloc内存管理的实现</h3><hr>
<blockquote>
<ol>
<li>本书本之前讨论的内存管理是基于GNUStep或者是CFFoundation里面的内存管理部分.现在NSObject已经开源了</li>
<li><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-709</a></li>
</ol>
</blockquote>
<h4 id="引用计数的储存"><a href="#引用计数的储存" class="headerlink" title="引用计数的储存"></a>引用计数的储存</h4><p>有些对象如果支持使用<code>TaggedPointer</code>，苹果会直接将其指针值作为引用计数返回；否则 Runtime 会使用一张<code>散列表</code>来管理引用计数。</p>
<h4 id="一些概念"><a href="#一些概念" class="headerlink" title="一些概念"></a>一些概念</h4><h5 id="1-TaggedPointer-判断当前对象是否在使用-TaggedPointer-是看标志位是否为-1-id的isTaggedPointer-方法经常会在操作引用计数时用到，因为这决定了存储引用计数的策略。"><a href="#1-TaggedPointer-判断当前对象是否在使用-TaggedPointer-是看标志位是否为-1-id的isTaggedPointer-方法经常会在操作引用计数时用到，因为这决定了存储引用计数的策略。" class="headerlink" title="1.TaggedPointer: 判断当前对象是否在使用 TaggedPointer 是看标志位是否为 1;id的isTaggedPointer()方法经常会在操作引用计数时用到，因为这决定了存储引用计数的策略。"></a>1.TaggedPointer: 判断当前对象是否在使用 TaggedPointer 是看标志位是否为 1;id的isTaggedPointer()方法经常会在操作引用计数时用到，因为这决定了存储引用计数的策略。</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_MSB_TAGGED_POINTERS</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> TAG_MASK (1ULL&lt;&lt;63)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> TAG_MASK 1</span></div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keyword">bool</span></div><div class="line">objc_object::isTaggedPointer()</div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_TAGGED_POINTERS</span></div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">uintptr_t</span>)<span class="keyword">this</span> &amp; TAG_MASK);</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-散列表"><a href="#2-散列表" class="headerlink" title="2.散列表"></a>2.散列表</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span> &#123;</span></div><div class="line">    <span class="comment">// 保证原子操作的自旋锁</span></div><div class="line">    <span class="keyword">spinlock_t</span> slock;</div><div class="line">    <span class="comment">// 引用计数的 hash 表</span></div><div class="line">    RefcountMap refcnts;</div><div class="line">    <span class="comment">// weak 引用全局 hash 表</span></div><div class="line">    <span class="keyword">weak_table_t</span> weak_table;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">SideTable 结构体重定了几个非常重要的变量。</div><div class="line"><span class="comment">// The order of these bits is important.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIDE_TABLE_WEAKLY_REFERENCED (1UL&lt;&lt;0)    </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIDE_TABLE_DEALLOCATING      (1UL&lt;&lt;1)  <span class="comment">// MSB-ward of weak bit</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIDE_TABLE_RC_ONE            (1UL&lt;&lt;2)  <span class="comment">// MSB-ward of deallocating bit</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIDE_TABLE_RC_PINNED         (1UL&lt;&lt;(WORD_BITS-1))<span class="comment">//最高位字节为0</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIDE_TABLE_RC_SHIFT 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIDE_TABLE_FLAG_MASK (SIDE_TABLE_RC_ONE-1)</span></div></pre></td></tr></table></figure>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717173215.png" alt="SamuelChan/20170717173215.png"></p>
<h5 id="3-retainCount"><a href="#3-retainCount" class="headerlink" title="3.retainCount"></a>3.retainCount</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSUInteger</span>)retainCount &#123;</div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>)<span class="keyword">self</span>)-&gt;rootRetainCount();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> uintptr_t</div><div class="line">objc_object::rootRetainCount()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (uintptr_t)<span class="keyword">this</span>;</div><div class="line">    <span class="keyword">return</span> sidetable_retainCount();</div><div class="line">&#125;</div><div class="line"></div><div class="line">uintptr_t</div><div class="line">objc_object::sidetable_retainCount()</div><div class="line">&#123;</div><div class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</div><div class="line">    size_t refcnt_result = <span class="number">1</span>;</div><div class="line"></div><div class="line">    table.lock();</div><div class="line">    RefcountMap::iterator it = table.refcnts.find(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">if</span> (it != table.refcnts.end()) &#123;</div><div class="line">        <span class="comment">// this is valid for SIDE_TABLE_RC_PINNED too</span></div><div class="line">        refcnt_result += it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;<span class="comment">//右移两位</span></div><div class="line">    &#125;</div><div class="line">    table.unlock();</div><div class="line">    <span class="keyword">return</span> refcnt_result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="4-retain"><a href="#4-retain" class="headerlink" title="4.retain"></a>4.retain</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)<span class="keyword">retain</span> &#123;</div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>)<span class="keyword">self</span>)-&gt;rootRetain();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Base retain implementation, ignoring overrides.</span></div><div class="line"><span class="comment">// This does not check isa.fast_rr; if there is an RR override then</span></div><div class="line"><span class="comment">// it was already called and it chose to call [super retain].</span></div><div class="line"><span class="keyword">inline</span> <span class="keyword">id</span></div><div class="line">objc_object::rootRetain()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</div><div class="line">    <span class="keyword">return</span> sidetable_retain();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">id</span></div><div class="line">objc_object::sidetable_retain()</div><div class="line">&#123;</div><div class="line"><span class="meta">#if SUPPORT_NONPOINTER_ISA</span></div><div class="line">    assert(!isa.nonpointer);</div><div class="line"><span class="meta">#endif</span></div><div class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</div><div class="line"></div><div class="line">    table.lock();</div><div class="line">    size_t&amp; refcntStorage = table.refcnts[<span class="keyword">this</span>];</div><div class="line">    <span class="keyword">if</span> (! (refcntStorage &amp; SIDE_TABLE_RC_PINNED)) &#123;</div><div class="line">    	<span class="comment">//相当于+(1 &lt;&lt; 2)</span></div><div class="line">        refcntStorage += SIDE_TABLE_RC_ONE;</div><div class="line">    &#125;</div><div class="line">    table.unlock();</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="5-release"><a href="#5-release" class="headerlink" title="5. release"></a>5. release</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">oneway</span> <span class="keyword">void</span>)release &#123;</div><div class="line">    ((<span class="keyword">id</span>)<span class="keyword">self</span>)-&gt;rootRelease();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> <span class="keyword">bool</span></div><div class="line">objc_object::rootRelease()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">return</span> sidetable_release(<span class="literal">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// rdar://20206767</span></div><div class="line"><span class="comment">// return uintptr_t instead of bool so that the various raw-isa</span></div><div class="line"><span class="comment">// -release paths all return zero in eax</span></div><div class="line">uintptr_t</div><div class="line">objc_object::sidetable_release(<span class="keyword">bool</span> performDealloc)</div><div class="line">&#123;</div><div class="line"><span class="meta">#if SUPPORT_NONPOINTER_ISA</span></div><div class="line">    assert(!isa.nonpointer);</div><div class="line"><span class="meta">#endif</span></div><div class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</div><div class="line">    <span class="keyword">bool</span> do_dealloc = <span class="literal">false</span>;</div><div class="line">    table.lock();</div><div class="line">    RefcountMap::iterator it = table.refcnts.find(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">if</span> (it == table.refcnts.end()) &#123;</div><div class="line">        do_dealloc = <span class="literal">true</span>;</div><div class="line">        table.refcnts[<span class="keyword">this</span>] = SIDE_TABLE_DEALLOCATING;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (it-&gt;second &lt; SIDE_TABLE_DEALLOCATING) &#123;</div><div class="line">        <span class="comment">// 判断引用计数是否为0,如果小于SIDE_TABLE_DEALLOCATING,只有00000001或者00000000,两种情况下,引用计数都为0,所以需要将do_dealloc置为0</span></div><div class="line">        <span class="comment">// SIDE_TABLE_WEAKLY_REFERENCED may be set. Don't change it.</span></div><div class="line">        do_dealloc = <span class="literal">true</span>;</div><div class="line">        it-&gt;second |= SIDE_TABLE_DEALLOCATING;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (! (it-&gt;second &amp; SIDE_TABLE_RC_PINNED)) &#123;</div><div class="line">    	 <span class="comment">// 如果符合这个条件,即:引用计数没有溢出(最高位为0),do_dealloc为0,weak_reference为0)</span></div><div class="line">        it-&gt;second -= SIDE_TABLE_RC_ONE;</div><div class="line">    &#125;</div><div class="line">    table.unlock();</div><div class="line">    <span class="keyword">if</span> (do_dealloc  &amp;&amp;  performDealloc) &#123;</div><div class="line">        ((<span class="keyword">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, SEL_dealloc);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> do_dealloc;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="6-alloc"><a href="#6-alloc" class="headerlink" title="6. alloc"></a>6. alloc</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">+alloc</div><div class="line">+allocWithZone:</div><div class="line">class_createInstance</div><div class="line">calloc</div></pre></td></tr></table></figure>
<h5 id="7-dealloc"><a href="#7-dealloc" class="headerlink" title="7.dealloc"></a>7.dealloc</h5><ol>
<li>objc_release.</li>
<li>dealloc is called because retain count becomes zero.</li>
<li>_objc_rootDealloc.</li>
<li>object_dispose.</li>
<li>objc_destructInstance</li>
<li>objc_clear_deallocating:<ol>
<li>From the weak table, get an entry of which the key is the object to be discarded.</li>
<li>Set nil to all the __weak ownership qualified variables in the entry.</li>
<li>Remove the entry from the table.</li>
<li>For the object to be disposed of, remove its <code>key</code> from the <strong><code>reference table</code></strong></li>
</ol>
</li>
</ol>
<h5 id="8-autorelease"><a href="#8-autorelease" class="headerlink" title="8.autorelease"></a>8.autorelease</h5><p>参考资料:<br><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="external">黑幕背后的Autorelease</a></p>
<ul>
<li>Autorelease对象什么时候释放？<br>在没有手加Autorelease Pool的情况下，Autorelease对象是在当前的runloop迭代结束时释放的，而它能够释放的原因是系统在每个runloop迭代中都加入了自动释放池Push和Pop</li>
<li>AutoreleasePoolPage:是一个C++实现的类,<br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717194057.png" alt="SamuelChan/20170717194057.png"><ul>
<li>AutoreleasePool并没有单独的结构，而是由若干个AutoreleasePoolPage以<a href="http://www.cnblogs.com/skywang12345/p/3561803.html#a31" target="_blank" rel="external">双向链表</a>的形式组合而成（分别对应结构中的parent指针和child指针）</li>
<li>AutoreleasePool是按线程一一对应的（结构中的thread指针指向当前线程）</li>
<li>AutoreleasePoolPage每个对象会开辟4096字节内存（也就是虚拟内存一页的大小），除了上面的实例变量所占空间，剩下的空间全部用来储存autorelease对象的地址</li>
<li>上面的id *next指针作为游标指向栈顶最新add进来的autorelease对象的下一个位置</li>
<li>一个AutoreleasePoolPage的空间被占满时，会新建一个AutoreleasePoolPage对象，连接链表，后来的autorelease对象在新的page加入</li>
</ul>
</li>
<li>AutoreleasePoolPage快要满的时候:也就是next指针马上指向栈顶，这时就要执行上面说的操作，建立下一页page对象，与这一页链表连接完成后，新page的next指针被初始化在栈底（begin的位置），然后继续向栈顶添加新对象。</li>
</ul>
<p><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717194341.png" alt="SamuelChan/20170717194341.png"></p>
<ul>
<li>释放时刻:根据哨兵位置进行pop释放池,每当进行一次objc_autoreleasePoolPush调用时，runtime向当前的AutoreleasePoolPage中add进一个哨兵对象，值为0（也就是个nil）<br><img src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170717194612.png" alt="SamuelChan/20170717194612.png"></li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> *context = objc_autoreleasePoolPush();</div><div class="line"><span class="comment">// &#123;&#125;中的代码</span></div><div class="line">objc_autoreleasePoolPop(context);</div></pre></td></tr></table></figure>
<ul>
<li>使用容器的block版本的枚举器时，内部会自动添加一个AutoreleasePool,普通for/for in中没有  <figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> [array enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">    <span class="comment">// 这里被一个局部@autoreleasepool包围着</span></div><div class="line">&#125;];</div></pre></td></tr></table></figure>
</li>
</ul>
<p>参考资料:<br>1.<a href="http://yulingtianxia.com/blog/2015/12/06/The-Principle-of-Refenrence-Counting/" target="_blank" rel="external">Objective-C 引用计数原理</a>,部分地方最新的obj4版本已经改了<br>2.<a href="http://zhoulingyu.com/2017/02/15/Advanced-iOS-Study-objc-Memory-2/" target="_blank" rel="external">iOS进阶——iOS（Objective-C）内存管理·二
</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/30/禅与Objective-C编程艺术/" rel="next" title="禅与Objective-C编程艺术读书笔记">
                <i class="fa fa-chevron-left"></i> 禅与Objective-C编程艺术读书笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/19/hello-world/" rel="prev" title="Hello World">
                Hello World <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ormqbgzmy.bkt.clouddn.com/SamuelChan/20170719163750.png"
               alt="SamuelChan" />
          <p class="site-author-name" itemprop="name">SamuelChan</p>
           
              <p class="site-description motion-element" itemprop="description">Good Luck Have fun!</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter1-Life-Before-Automatic-Reference-Counting"><span class="nav-number">1.</span> <span class="nav-text">Chapter1 Life Before Automatic Reference Counting</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Reference-Counted-Memory-Management-Overview"><span class="nav-number">1.1.</span> <span class="nav-text">Reference Counted Memory Management Overview</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exploring-Memory-Management-Further"><span class="nav-number">1.2.</span> <span class="nav-text">Exploring Memory Management Further</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#You-Have-Ownership-of-Any-Objects-You-Create"><span class="nav-number">1.2.1.</span> <span class="nav-text">You Have Ownership of Any Objects You Create</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#You-Can-Take-Ownership-of-an-Object-Using-retain"><span class="nav-number">1.2.2.</span> <span class="nav-text">You Can Take Ownership of an Object Using retain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#When-No-Longer-Needed-You-Must-Relinquish-Ownership-of-an-Object-You-Own"><span class="nav-number">1.2.3.</span> <span class="nav-text">When No Longer Needed, You Must Relinquish Ownership of an Object You Own</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#You-Must-Not-Relinquish-Ownership-of-an-Object-You-Don’t-Own"><span class="nav-number">1.2.4.</span> <span class="nav-text">You Must Not Relinquish Ownership of an Object You Don’t Own</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Implementing-alloc-retain-release-and-dealloc"><span class="nav-number">1.3.</span> <span class="nav-text">Implementing alloc, retain, release, and dealloc</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#GNUStep-implementation"><span class="nav-number">1.3.1.</span> <span class="nav-text">GNUStep implementation</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Apple’s-Implementation-of-alloc-retain-release-and-dealloc"><span class="nav-number">1.3.2.</span> <span class="nav-text">Apple’s Implementation of alloc, retain, release, and dealloc</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Autorelease"><span class="nav-number">1.4.</span> <span class="nav-text">Autorelease</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Implementing-autorelease"><span class="nav-number">1.4.1.</span> <span class="nav-text">Implementing autorelease</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter2-ARC-Rules"><span class="nav-number">2.</span> <span class="nav-text">Chapter2 ARC Rules</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Ownership-qualifiers"><span class="nav-number">2.1.</span> <span class="nav-text">Ownership qualifiers</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-strong-ownership-qualifier"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.__strong ownership qualifier</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-weak-ownership-qualifier"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.__weak ownership qualifier</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-unsafe-unretained-ownership-qualifier"><span class="nav-number">2.1.3.</span> <span class="nav-text">3.__unsafe_unretained ownership qualifier</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-autoreleasing-ownership-qualifier"><span class="nav-number">2.1.4.</span> <span class="nav-text">4.__autoreleasing ownership qualifier</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Rules"><span class="nav-number">2.2.</span> <span class="nav-text">Rules</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Core-Foundation"><span class="nav-number">2.2.1.</span> <span class="nav-text">Core Foundation</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Property"><span class="nav-number">2.3.</span> <span class="nav-text">Property</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter-3-ARC-implementation"><span class="nav-number">3.</span> <span class="nav-text">Chapter 3 ARC implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#strong"><span class="nav-number">3.1.</span> <span class="nav-text">__strong</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#weak"><span class="nav-number">3.2.</span> <span class="nav-text">__weak</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#autoreleasing"><span class="nav-number">3.3.</span> <span class="nav-text">__autoreleasing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Reference-Count"><span class="nav-number">3.4.</span> <span class="nav-text">Reference Count</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSObject开源release-retain-dealloc内存管理的实现"><span class="nav-number">4.</span> <span class="nav-text">NSObject开源release,retain,dealloc内存管理的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#引用计数的储存"><span class="nav-number">4.1.</span> <span class="nav-text">引用计数的储存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#一些概念"><span class="nav-number">4.2.</span> <span class="nav-text">一些概念</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-TaggedPointer-判断当前对象是否在使用-TaggedPointer-是看标志位是否为-1-id的isTaggedPointer-方法经常会在操作引用计数时用到，因为这决定了存储引用计数的策略。"><span class="nav-number">4.2.1.</span> <span class="nav-text">1.TaggedPointer: 判断当前对象是否在使用 TaggedPointer 是看标志位是否为 1;id的isTaggedPointer()方法经常会在操作引用计数时用到，因为这决定了存储引用计数的策略。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-散列表"><span class="nav-number">4.2.2.</span> <span class="nav-text">2.散列表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-retainCount"><span class="nav-number">4.2.3.</span> <span class="nav-text">3.retainCount</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-retain"><span class="nav-number">4.2.4.</span> <span class="nav-text">4.retain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-release"><span class="nav-number">4.2.5.</span> <span class="nav-text">5. release</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-alloc"><span class="nav-number">4.2.6.</span> <span class="nav-text">6. alloc</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-dealloc"><span class="nav-number">4.2.7.</span> <span class="nav-text">7.dealloc</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-autorelease"><span class="nav-number">4.2.8.</span> <span class="nav-text">8.autorelease</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SamuelChan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("5DXEtyIfD1Td3xo3s9t77pe0-gzGzoHsz", "adHDX8YCoxhJyNPBn4h7WQed");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
